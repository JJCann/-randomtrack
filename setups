/*
 * Nightbot command:
 * !editcom -ul=everyone -cd=5 !setup $(eval group('$(query)', $(urlfetch json https://docs.google.com/spreadsheets/d/1UsH6nEb4xOgtMsY-yq1fCHG8LOONxC7FucplEBFhB7s/export?exportFormat=tsv)); $(urlfetch json https://raw.githubusercontent.com/JJCann/-randomtrack/master/setups);)
*/
function group(query = '', data = {}) {
    query = normalize(query);

    /* Find all car that match the specified track type */
    const [groupname] = parse_query(query);
    const groups = data[groupname];
    if (groups !== Object(groups)) {
        return 'To use this command, write !setup, then a space, then the car you want (no spaces or special characters in car name). For a full list of cars, check the list here - https://tinyurl.com/tea3fvu7'
    }
 
    /* Output a random group (or error message) */
    if (groups.length > 0) {
        const i = Math.floor(Math.random() * groups.length);
        const group = groups[i];
        
        return group "    This is a basic setup. You will need to do your own testing to refine this, and this is only a starting point!";
    }
    return 'Could not find a matching random group ¯\\_(ツ)_/¯';
}

function normalize(text) {
    if (!text) {
        text = '';
    }

    /* Convert to lowercase */
    text = text.toLowerCase();

    /* Remove plural (unless part of 'PS 4')*/
    text = text.replace(/(?<=\bp)s\b(?=4)/g, '');

    /* Remove accents */
    text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

    /* Remove everything behind '@' */
    text = text.replace(/\s*@.*/, '');

    /* Remove all chars that are not letters */
    text = text.replace(/[^a-z0-9 ]+/g, '');

    return text;
}

function parse_query(query_before='') {
    var query_after = '';

    query_after = query_before.replace(/\b811\b/g, '');
    if (query_before !== query_after) return ['811', query_after.trim()];

   
   return ['', query_before];
}
